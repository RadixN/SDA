---
title: "SIT741 Week 6 Practical" 
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, eval = TRUE)
```


## Learning Goal
1. You can use ggplot2 to visualise relationships between variables
2. You can use write model specifications using R model formula

## Four steps of regression modeling
During the lecture, we mentioned four steps of regression modeling.

1. Visual exploration of the relationships
2. Hypothesize the model
3. Fit the model
4. Validate the assumptions 

In practice, the second step is often intertwined with Step 1 and Step 3.

## Visual exploration of relationship

### ggplot2

There are many ways to generate plots in R, but in this unit we shall focus on the `ggplot2` package. 
A ggplot is generated by filling in the following template:

```{r eval=FALSE}
ggplot(data = <DATA>) + 
  <GEOM_FUNCTION>(mapping = aes(<MAPPINGS>))
```

> If you have not read Chapter 3 and 7 of R4DS, you are encouraged to read those two chapters first.

> After you've done the reading, answer this question: In a bar chart, what are the aesthetics? What are the geometric objects?


### relationships between two categorical variables

For two categorical variables, the relationships is often summarised in the contigency table.
Yes, we can visualise the contigency table.
```{r}
library(tidyverse)
library(nycflights13)

flights %>% 
  inner_join(airlines) %>% 
  ggplot() + 
  geom_count(mapping = aes(x = origin, 
                           y = name))
```

> How are airlines associated with the airport? Alaska Airlines is the major carrier headquartered in Seattle. Which New York airport would a Seattle passenger most likely use?

You can also visualise it with multiple bar charts.
```{r}
flights %>% 
  inner_join(airlines) %>% 
  ggplot() + 
  geom_bar(mapping = aes(x = name)) +
  facet_grid(.~origin) +
  coord_flip()
```

> Follow the example above and find out the major airlines using some other destination airports. (You may limit your analysis to only the top four destination airports.)

### One categorical variable and one continuous variable

You can use the box plot to compare several distributions.
```{r}
flights %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = origin, 
                             y = distance))
```
Which airport serves more long haul flights?

You can also use the violin plot. 
```{r}
flights %>% 
  ggplot() +
  geom_violin(mapping = aes(x = origin, 
                            y = distance))
```
Are the differences as convincing as before? 

> Compare the arrival and departure delays for the three airports.

### relationships between two continuous variables

Correlation analysis can be performed on two continuous variables.
```{r}
flights %>% 
  sample_n(size = 100) %>% 
  ggplot() +
  geom_point(mapping = aes(x = distance, y = air_time))
```
It works when the number of observations is small. When the number is big, sometime jittering may help.
```{r}
flights %>% 
  sample_n(size = 1000) %>% 
  ggplot() +
  geom_jitter(mapping = aes(x = distance, y = air_time))
```
Or we can make the points transparent.
```{r}
flights %>% 
  sample_n(size = 1000) %>% 
  ggplot() +
  geom_point(mapping = aes(x = distance, 
                           y = air_time), 
             alpha = 1/20)
```

> Do you see a strong correlation between the distance and the air time? Is it a positive correlation? Is it linear?

Sometimes, it is helpful to add a curvy line.

```{r}
flights %>% 
  sample_n(size = 10) %>% 
  ggplot(mapping = aes(x = distance, 
                           y = air_time)) +
  geom_point(alpha = 1/10) +
  geom_smooth(color = 'steelblue') + ### find some smooth curve related to the date, with larger saple the curve will turn towards line 
  geom_smooth(method = 'lm',### use linear method 
              color = 'firebrick')
```

Or a line from a formal model:

```{r}
flights %>% 
  sample_n(size = 1000) %>% 
  ggplot(mapping = aes(x = distance, 
                           y = air_time)) +
  geom_point(alpha = 1/10) +
  geom_smooth(method = 'lm',
              color = 'firebrick')
```

> Analyse the correlation between the departure delay and the arrival delay.

```{r echo=FALSE}
flights %>% 
  sample_n(size = 1000) %>% 
  ggplot() +
  geom_point(mapping = aes(x = dep_delay, 
                           y = arr_delay), 
             alpha = 1/10)
```




## R model formulas
Many R packages expect the following format of model specification: `response ~ predictor`.

```{r}
library(MASS)
(
model_lm <- lm(medv ~ lstat, 
               data = Boston) ##gives y intercept(34.55) and slope of the model(-0.95 )
)
```

### Operators

The `predictor` clause can have a set of additive terms connected through the `+` operator (e.g., for multiple linear regression).
```{r}
(
model_lm2 <- lm(medv ~ lstat + age, 
                data = Boston)
)
```

With an earlier fitted model, you can modify the existing formula with `update`:
```{r}
(
model_lm2 <- model_lm %>% 
  update(. ~ . + age)
)
```


Somewhat less intuitive is the operator `-`, which is used to remove a term from the model.
```{r}
(
model_lm <- model_lm2 %>% 
  update(. ~ . - age)
)
```
### medv =34.55-0.95 * lstat

The intercept term is denoted `1`, but is implicitly included. The following model has a regression line passing through the origin.
```{r}
(
model_lm0 <- model_lm %>% 
  update(. ~ . -1)
)
```
### medv =1.122 * lstat
Or equivalently.

```{r}
(
model_lm0 <- lm(medv ~ lstat + 0, 
                data = Boston)
)
```

This is particularly useful when the only predictor variable is categorical (ANOVA) and you don't want a reference group.


```{r}
(
model_anova <- lm(mpg ~ (cyl) - 1, 
                  data = mtcars)
)
###what is the right formula ? mpg~2.79*factor, is is a correct model ? or should we convert it to categorical ?
```



```{r}
(
model_anova <- lm(mpg ~ factor(cyl) - 1, 
                  data = mtcars)
)
###what is the right formula ? mpg~26.66*factor(cyl)4 +19.74* factor(cyl)6+  15.10*factor(cyl)8 ?????
```


> Update the model to include an intercept term. How are the fitted coefficients different? 

```{r echo = FALSE}
(
model_anova2 <- update(model_anova, 
                       . ~ . + 1)
)
```

The interaction terms can be introduced through the `:` operator.
```{r}
(
model_lm_i1 <- lm(mpg ~ wt + 
                    factor(cyl) + 
                    wt:factor(cyl), 
                  data = mtcars)
)
```

The above predictor clause can be replaced by `wt*factor(cyl)`, where the `*` operator introduces both the interaction and the main effects. Think of it as a shorthand.
```{r}
(
model_lm_i2 <- lm(mpg ~ wt*factor(cyl), 
                  data = mtcars)
)
#we dnt see cylinder 4 since its coefficient is zero 
```

counter-intuitively, this can also  be written as:
```{r}
(
model_lm_i3 <- lm(mpg ~ (wt + factor(cyl))^2, 
                  data = mtcars)
)
```


> Compare the three models. Are they different? 

There is yet another shorthand operator `/`. 

> Can you rewrite the following formula using only `+` and `:` operators?

```{r}
(
  model_lm3 <- lm(mpg ~ wt/factor(cyl), 
                data = mtcars)
)
#Here its same as product but you exclude the variable in denominator in the output 
```


### The inhibit function and other conventions
What if you want to include a cubic term of `wt` in the formula? You cannot just use `^3` as `^` already has a different meaning. This is where you need the inhibit function `I`.
```{r}
(
model_lm4 <-  lm(mpg ~ (I(wt^3) + factor(cyl))^2, 
                 data = mtcars)
)
```

> Can you explain the different roles two `^`s play in the above model?

Although it is not always appropriate, you can blindly include all variables in a data frame as explanatory variables for a model.

```{r}
(
model_lm5 <- lm(mpg ~ . , 
                data = mtcars %>% 
                  mutate(cyl = factor(cyl)))
)
```

> Does `.` play the same role as in 'model_lm2'?

You can even do the following.
```{r}
(
  model_lm6 <- lm(data = mtcars %>% 
                  mutate(cyl = factor(cyl)))
)
```

> What is the formula in `model_lm6`?

A good summary of the formula syntax can be found [here](https://sites.google.com/site/r4naturalresources/r-topics/fitting-models/formulas).

### A word of warning

When you see an overly complicated formula, think about whether you can clean up the data first. Use the *mutate* function to create the extra features may often be a better option.

## Summary


1. ggplot2 provides functions to help visualise relationships between variables.
2. R provides rich syntax for specifying a model. 
 


## Your turn

1. You can read Hadley Wickham's paper *A Layered Grammar of Graphics* [here](http://vita.had.co.nz/papers/layered-grammar.pdf).

2. Read Chapter 23 of [R4DS](https://r4ds.had.co.nz/model-basics.html): *Model basics*.

```{r}
# Libraries
library(nycflights13)
library(tidyverse)

# Filter flights departing JFK and calculate the mean air-time
mean_airtime_JFK <- flights %>%
  filter(origin == "JFK") %>%  # filter by JFK
  summarize(mean_air_time_JFK = mean(air_time, na.rm = TRUE)) # calculate mean time

# Print the result
print(mean_airtime_JFK)
```


